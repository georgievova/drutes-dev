\section{fem\+\_\+tools Module Reference}
\label{namespacefem__tools}\index{fem\+\_\+tools@{fem\+\_\+tools}}
\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine, public {\bf in2global} (el\+\_\+id, locmatrix, bvect, subprmt, debugme)
\begin{DoxyCompactList}\small\item\em procedure to put local stiffness matrix into the global stiffness matrix \end{DoxyCompactList}\item 
subroutine, public {\bf icond4neumann} (proc)
\end{DoxyCompactItemize}


\subsection{Function/\+Subroutine Documentation}
\index{fem\+\_\+tools@{fem\+\_\+tools}!icond4neumann@{icond4neumann}}
\index{icond4neumann@{icond4neumann}!fem\+\_\+tools@{fem\+\_\+tools}}
\subsubsection[{icond4neumann(proc)}]{\setlength{\rightskip}{0pt plus 5cm}subroutine, public fem\+\_\+tools\+::icond4neumann (
\begin{DoxyParamCaption}
\item[{integer(kind=ikind), intent(in)}]{proc}
\end{DoxyParamCaption}
)}\label{namespacefem__tools_aef722f7948c3d119dc3410f572f26821}


Definition at line 165 of file fem\+\_\+tools.\+f90.



References globals\+::drutes\+\_\+config, globals\+::elements, simplelinalg\+::invert\+\_\+matrix(), globals\+::nodes, pde\+\_\+objs\+::pde, pde\+\_\+objs\+::pde\+\_\+common, and core\+\_\+tools\+::write\+\_\+log().



Referenced by femmat\+::solve\+\_\+picard().


\begin{DoxyCode}
165     \textcolor{keywordtype}{use }typy
166     \textcolor{keywordtype}{use }globals
167     \textcolor{keywordtype}{use }global_objs
168     \textcolor{keywordtype}{use }pde_objs
169     \textcolor{keywordtype}{use }core_tools
170     \textcolor{keywordtype}{use }simplelinalg
171 
172     \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{intent(in)} :: proc
173     \textcolor{keywordtype}{integer(kind=ikind)} :: i,j,k,l,m,n,d, o, kk, nn, code, z
174    
175     \textcolor{keywordtype}{logical}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{save} :: evaluated
176     \textcolor{keywordtype}{real(kind=rkind)} :: tmp, length, der
177     \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(3)} :: gradh, velocity
178     \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(3,3)} :: disp
179     \textcolor{keywordtype}{logical} :: gofurther
180 
181     \textcolor{keywordflow}{if} (.not. \textcolor{keyword}{allocated}(evaluated)) \textcolor{keywordflow}{then}
182       \textcolor{keyword}{allocate}(evaluated(nodes%kolik))
183 \textcolor{keywordflow}{    end if}
184 
185     evaluated = .false.
186 
187     d = drutes_config%dimen
188 
189     \textcolor{keywordflow}{do} i=1, elements%kolik
190       \textcolor{keywordflow}{do} j=1, ubound(elements%data,2)
191         k = elements%data(i,j)
192         l = nodes%edge(k)
193         \textcolor{keywordflow}{if} (.not.evaluated(k) .and. elements%length(i,j) > epsilon(tmp) .and. l >= lbound(
      pde(proc)%bc,1)) \textcolor{keywordflow}{then}
194           \textcolor{keywordflow}{if} (pde(proc)%bc(l)%code == 2 .and. pde(proc)%bc(l)%icond4neumann) \textcolor{keywordflow}{then}
195             \textcolor{keywordflow}{do} m=1, ubound(elements%data,2)
196               o = nodes%edge(elements%data(i,m))
197               \textcolor{keywordflow}{if} (o >= lbound(pde(proc)%bc,1)) \textcolor{keywordflow}{then}
198                 \textcolor{keywordflow}{if} (pde(proc)%bc(o)%code /= 2) \textcolor{keywordflow}{then}
199                   gofurther = .true.
200                 \textcolor{keywordflow}{else}
201                   gofurther = .false.
202 \textcolor{keywordflow}{                end if}
203               \textcolor{keywordflow}{else}
204                 gofurther = .true.
205 \textcolor{keywordflow}{              end if}
206               \textcolor{keywordflow}{if} (gofurther) \textcolor{keywordflow}{then}
207                 \textcolor{keyword}{call }pde(proc)%bc(l)%value\_fnc(pde(proc), i, j, tmp, code)
208                 \textcolor{keywordflow}{select case}(drutes_config%dimen)
209                     \textcolor{keywordflow}{case}(1)
210                       velocity(1) = elements%nvect\_z(i,j)*tmp
211                     \textcolor{keywordflow}{case}(2)
212                       velocity(1) = sqrt(1-elements%nvect\_z(i,j)*elements%nvect\_z(i,j))*tmp
213                       velocity(2) = elements%nvect\_z(i,j)*tmp
214 \textcolor{keywordflow}{                end select}
215 
216                 kk = pde(proc)%permut(k)
217 
218                 \textcolor{keyword}{call }pde(proc)%pde\_fnc(proc)%dispersion(pde(proc), &
219                 elements%material(i,proc),x=(/pde_common%xvect(kk,1)/), & 
220                                                           tensor=disp(1:d, 1:d))
221 
222                 \textcolor{keywordflow}{do} z=1, d
223                   \textcolor{keywordflow}{if} ( disp(z,z) < 10*epsilon(tmp)) \textcolor{keywordflow}{then}
224                     \textcolor{keyword}{call }write_log(\textcolor{stringliteral}{"W: dispersion is nearly zero"})
225                     \textcolor{keywordflow}{RETURN}
226 \textcolor{keywordflow}{                  end if}
227 \textcolor{keywordflow}{                end do}
228 
229                 \textcolor{keyword}{call }invert_matrix(disp(1:d, 1:d))
230 
231                 gradh(1:d) = matmul(disp(1:d, 1:d), velocity(1:d))
232 
233                 \textcolor{keywordflow}{EXIT}
234 
235 \textcolor{keywordflow}{              end if}
236 \textcolor{keywordflow}{            end do}
237 
238             \textcolor{keywordflow}{if} (m==4) \textcolor{keywordflow}{then}
239               print *, \textcolor{stringliteral}{"ERROR: possibly strange mesh, contact developer, called from
       fem\_tools::icond4neumann"}
240               print *, \textcolor{stringliteral}{"element id is: "}, i
241               error stop
242 \textcolor{keywordflow}{            end if}
243             n = elements%data(i,m)
244 
245             nn = pde(proc)%permut(n)
246             pde_common%xvect(kk,1) = pde_common%xvect(nn,1)
247             \textcolor{keywordflow}{do} o=1,d
248               pde_common%xvect(kk,1) = pde_common%xvect(kk,1) - (nodes%data(k,o)-
      nodes%data(n,o))*gradh(o)
249 \textcolor{keywordflow}{            end do}
250             evaluated(k) = .true.
251 \textcolor{keywordflow}{          end if}
252 \textcolor{keywordflow}{        end if}
253 \textcolor{keywordflow}{      end do}
254 \textcolor{keywordflow}{    end do}
255 
\end{DoxyCode}


Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacefem__tools_aef722f7948c3d119dc3410f572f26821_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacefem__tools_aef722f7948c3d119dc3410f572f26821_icgraph}
\end{center}
\end{figure}


\index{fem\+\_\+tools@{fem\+\_\+tools}!in2global@{in2global}}
\index{in2global@{in2global}!fem\+\_\+tools@{fem\+\_\+tools}}
\subsubsection[{in2global(el\+\_\+id, locmatrix, bvect, subprmt, debugme)}]{\setlength{\rightskip}{0pt plus 5cm}subroutine, public fem\+\_\+tools\+::in2global (
\begin{DoxyParamCaption}
\item[{integer(kind=ikind), intent(in)}]{el\+\_\+id, }
\item[{class({\bf extsmtx}), intent(inout)}]{locmatrix, }
\item[{real(kind=rkind), dimension(\+:)}]{bvect, }
\item[{integer(kind=ikind), dimension(\+:), intent(in), optional}]{subprmt, }
\item[{logical, intent(in), optional}]{debugme}
\end{DoxyParamCaption}
)}\label{namespacefem__tools_a70a2c3916a63fabc299dbbb53741e122}


procedure to put local stiffness matrix into the global stiffness matrix 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em el\+\_\+id} & number of element\\
\hline
\mbox{\tt in}  & {\em subprmt} & permutation array for submatrices, supplied only for domain decomposition problems \\
\hline
\end{DoxyParams}


Definition at line 26 of file fem\+\_\+tools.\+f90.



References globals\+::bside, globals\+::drutes\+\_\+config, globals\+::elements, globals\+::nodes, pde\+\_\+objs\+::pde, globals\+::stiff\+\_\+mat, and globals\+::time\+\_\+step.



Referenced by femmat\+::assemble\+\_\+mat(), schwarz\+\_\+dd\+::locmat\+\_\+assembler(), and schwarz\+\_\+dd2subcyc\+::locmat\+\_\+assembler().


\begin{DoxyCode}
26     \textcolor{keywordtype}{use }typy
27     \textcolor{keywordtype}{use }sparsematrix
28     \textcolor{keywordtype}{use }global_objs
29     \textcolor{keywordtype}{use }pde_objs
30     \textcolor{keywordtype}{use }globals
31     \textcolor{keywordtype}{use }debug_tools
32     
34     \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{intent(in)} :: el\_id
35     \textcolor{keywordtype}{class}(extsmtx), \textcolor{keywordtype}{intent(in out)}  :: locmatrix
36     \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(:)} :: bvect
38     \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(in)}, \textcolor{keywordtype}{optional} :: subprmt
39     \textcolor{keywordtype}{logical}, \textcolor{keywordtype}{intent(in)}, \textcolor{keywordtype}{optional} :: debugme
40     
41     \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{save} :: bc
42     \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{save} :: n\_row, m\_col
43     \textcolor{keywordtype}{integer(kind=ikind)} :: i,j,m, iproc, jproc, limits
44     \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{save} :: bcval
45     \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{save} :: surface
46     \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{save} :: fin
47     \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(3,3)} :: d
48    
49 
50     \textcolor{keywordflow}{if} (.not. \textcolor{keyword}{allocated}(bc)) \textcolor{keywordflow}{then}       
51       \textcolor{keyword}{allocate}(bc(ubound(stiff_mat,1)))
52       \textcolor{keyword}{allocate}(n\_row(ubound(stiff_mat,1)))
53       \textcolor{keyword}{allocate}(m\_col(ubound(stiff_mat,1)))
54       \textcolor{keyword}{allocate}(bcval(ubound(stiff_mat,1)))
55       \textcolor{keyword}{allocate}(surface(ubound(stiff_mat,1)))
56       \textcolor{keyword}{allocate}(fin(ubound(pde,1)))
57 \textcolor{keywordflow}{    end if}
58     
59     surface = 0
60     bc = 0
61     n\_row = 0
62     m\_col = 0
63     bcval = 0
64     limits = ubound(stiff_mat,1)/ubound(pde,1)
65         
66 
67     \textcolor{keywordflow}{do} iproc=0, ubound(pde,1)-1
68       \textcolor{keywordflow}{do} i=1, ubound(elements%data, 2)  
69         surface(i+iproc*limits) = elements%length(el\_id,i)
70 \textcolor{keywordflow}{      end do}
71 \textcolor{keywordflow}{    end do}
72     
73     
74     \textcolor{keywordflow}{do} iproc = 0,ubound(pde,1)-1
75       \textcolor{keywordflow}{do} i=1, ubound(elements%data, 2)
76         j = elements%data(el\_id,i)
77         n\_row(i+iproc*limits) = pde(iproc+1)%permut(j)
78         \textcolor{keywordflow}{if} (nodes%edge(j) > 100) \textcolor{keywordflow}{then}
79           m = nodes%edge(j)
80           \textcolor{keyword}{call }pde(iproc+1)%bc(m)%value\_fnc(pde(iproc+1), el\_id,i,bcval(i+iproc*limits),bc(i+iproc*limits))
81         \textcolor{keywordflow}{else}
82           bc(i) = 0
83 \textcolor{keywordflow}{        end if}
84 \textcolor{keywordflow}{      end do}
85 \textcolor{keywordflow}{    end do}
86     
87     
88 
89     
90 
91     \textcolor{keywordflow}{if} (\textcolor{keyword}{present}(subprmt)) \textcolor{keywordflow}{then}
92       \textcolor{keywordflow}{do} i=1, ubound(m\_col,1)
93         \textcolor{keywordflow}{if} (n\_row(i) > 0 ) \textcolor{keywordflow}{then}
94           m\_col(i) = subprmt(n\_row(i))
95 \textcolor{keywordflow}{        end if}
96 \textcolor{keywordflow}{      end do}
97     \textcolor{keywordflow}{else}
98       m\_col=n\_row
99 \textcolor{keywordflow}{    end if}
100 
101  
102 
103     \textcolor{keywordflow}{do} i=1, ubound(stiff_mat,1)
104       \textcolor{comment}{! fill bside}
105       \textcolor{keywordflow}{if} (bc(i) /= 1) \textcolor{keywordflow}{then}
106         \textcolor{keywordflow}{select case}(bc(i))
107           \textcolor{keywordflow}{case}(0,3)
108               \textcolor{keywordflow}{if} (m\_col(i) > 0) \textcolor{keywordflow}{then}
109                 bvect(m\_col(i)) = bvect(m\_col(i)) + bside(i)
110 \textcolor{keywordflow}{              end if}
111           \textcolor{keywordflow}{case}(2)
112               \textcolor{keywordflow}{if} (m\_col(i) > 0) \textcolor{keywordflow}{then}
113                 bvect(m\_col(i)) = bvect(m\_col(i)) - bcval(i)*surface(i)*
      time_step + bside(i)
114 \textcolor{keywordflow}{              end if}
115           \textcolor{keywordflow}{case}(4)
116               bvect(m\_col(i)) = bcval(i)
117 \textcolor{keywordflow}{        end select}
118         \textcolor{comment}{! fill stiffness matrix}
119         \textcolor{keywordflow}{do} m=1, ubound(stiff_mat,1)
120           \textcolor{keywordflow}{select case}(bc(m))
121             \textcolor{keywordflow}{case}(1)
122                 \textcolor{keywordflow}{if} (m\_col(i) > 0) \textcolor{keywordflow}{then}
123                   bvect(m\_col(i)) = bvect(m\_col(i)) - stiff_mat(i,m)*bcval(m)
124 \textcolor{keywordflow}{                end if}
125                 
126             \textcolor{keywordflow}{case}(4)
127                 \textcolor{keywordflow}{if} (i == m) \textcolor{keywordflow}{then}
128                   \textcolor{keyword}{call }locmatrix%set(1.0\_rkind, n\_row(i), m\_col(i))
129                   \textcolor{keywordflow}{if} (drutes_config%it\_method == 2 .or. drutes_config%it\_method == 1) \textcolor{keywordflow}{then}
130                     \textcolor{keyword}{call }locmatrix%rowsfilled%nrfill(n\_row(i))
131 \textcolor{keywordflow}{                  end if}
132 \textcolor{keywordflow}{                end if}
133 \textcolor{keywordflow}{            case default}
134                 
135                 \textcolor{keywordflow}{if} (bc(i) /= 4 ) \textcolor{keywordflow}{then} 
136                   \textcolor{keywordflow}{if} (n\_row(i) > 0 .and. m\_col(m) > 0) \textcolor{keywordflow}{then}
137                     \textcolor{keyword}{call }locmatrix%add(stiff_mat(i,m), n\_row(i), m\_col(m))
138                     \textcolor{keywordflow}{if} (drutes_config%it\_method == 2 .or. drutes_config%it\_method == 1) \textcolor{keywordflow}{then}
139                       \textcolor{keyword}{call }locmatrix%rowsfilled%nrfill(n\_row(i))
140 \textcolor{keywordflow}{                    end if}
141 \textcolor{keywordflow}{                  end if}
142 \textcolor{keywordflow}{                end if}
143                 
144 
145               \textcolor{comment}{!**!}
146 \textcolor{comment}{!             spmatrix%vals(g\_row) = stiff\_mat(i,m)}
147 \textcolor{comment}{!             spmatrix%ii(g\_row) = n(i)}
148 \textcolor{comment}{!             spmatrix%jj(g\_row) = n(m)}
149 \textcolor{comment}{!             g\_row = g\_row + 1}
150 \textcolor{keywordflow}{          end select}
151 \textcolor{keywordflow}{        end do}
152       \textcolor{keywordflow}{else}
153         \textcolor{keywordflow}{CONTINUE}
154 \textcolor{keywordflow}{      end if}
155 \textcolor{keywordflow}{    end do}
156           
157 
158   
\end{DoxyCode}


Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacefem__tools_a70a2c3916a63fabc299dbbb53741e122_icgraph}
\end{center}
\end{figure}


