\section{objfnc Module Reference}
\label{namespaceobjfnc}\index{objfnc@{objfnc}}
\subsection*{Data Types}
\begin{DoxyCompactItemize}
\item 
type {\bf point\+\_\+str}
\item 
type {\bf ram\+\_\+limit\+\_\+str}
\end{DoxyCompactItemize}
\subsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine, private {\bf reader} ()
\item 
subroutine, public {\bf get\+\_\+objval} ()
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
integer, private {\bf exp\+\_\+file}
\item 
type({\bf point\+\_\+str}), dimension(\+:), allocatable, private {\bf exp\+\_\+data}
\item 
type({\bf point\+\_\+str}), dimension(\+:), allocatable, private {\bf model\+\_\+data}
\item 
integer(kind=ikind), dimension(\+:), allocatable, private {\bf obs\+\_\+ids}
\item 
integer(kind=ikind), dimension(\+:), allocatable, private {\bf noprop}
\item 
integer(kind=ikind), dimension(\+:), allocatable, private {\bf pde\+\_\+comp}
\item 
integer(kind=ikind), dimension(\+:,\+:), allocatable, private {\bf columns}
\item 
character(len=4096), private {\bf fileinputs}
\item 
type({\bf ram\+\_\+limit\+\_\+str}), private {\bf ram\+\_\+limit}
\item 
integer(kind=ikind), private {\bf no\+\_\+pdes}
\item 
integer, dimension(\+:), allocatable {\bf datafiles}
\end{DoxyCompactItemize}


\subsection{Function/\+Subroutine Documentation}
\index{objfnc@{objfnc}!get\+\_\+objval@{get\+\_\+objval}}
\index{get\+\_\+objval@{get\+\_\+objval}!objfnc@{objfnc}}
\subsubsection[{get\+\_\+objval()}]{\setlength{\rightskip}{0pt plus 5cm}subroutine, public objfnc\+::get\+\_\+objval (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{namespaceobjfnc_aa9a5392e2af633f2f53554a6f6f93026}


Definition at line 350 of file objfnc.\+f90.



References exp\+\_\+data, model\+\_\+data, noprop, and reader().



Referenced by main().


\begin{DoxyCode}
350       \textcolor{keywordtype}{use }typy
351       \textcolor{keywordtype}{use }debug_tools
352       \textcolor{keywordtype}{integer(kind=ikind)} :: i,j, pos, k, n, l
353       \textcolor{keyword}{type} :: errors\_str
354         \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: val
355 \textcolor{keyword}{      end type}
356       \textcolor{keywordtype}{type}(errors\_str), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: errors
357       \textcolor{keywordtype}{logical} :: inlast 
358       \textcolor{keywordtype}{integer} :: outfile
359       \textcolor{keywordtype}{real(kind=rkind)} :: dt, slope, modval, suma
360       
361       
362       \textcolor{keyword}{call }reader()
363 
364       \textcolor{keyword}{allocate}(errors(ubound(model\_data,1)))
365       
366       \textcolor{keywordflow}{do} i=1, ubound(errors,1)
367         \textcolor{keyword}{allocate}(errors(i)%val(noprop(i)))
368         errors(i)%val = 0
369 \textcolor{keywordflow}{      end do}
370       
371       
372       pos = 1
373       \textcolor{keywordflow}{do} j=1, ubound(exp\_data(1)%time,1) 
374         \textcolor{keywordflow}{do} k=pos, ubound(model\_data(1)%time,1)-1
375           \textcolor{keywordflow}{if} (exp\_data(1)%time(j) >=  model\_data(1)%time(k) .and. exp\_data\textcolor{comment}{(1)%time(j) < model\_data(1)%time(
      k+1)) }\textcolor{keywordflow}{then}
376             dt = model\_data(1)%time(k+1) - exp\_data(1)%time(j)
377             \textcolor{keywordflow}{if} (dt < model\_data(1)%time(k+1)*epsilon(dt)) \textcolor{keywordflow}{then}
378               inlast = .true.
379             \textcolor{keywordflow}{else}
380               inlast = .false.
381 \textcolor{keywordflow}{            end if}
382             
383             pos = k
384             
385             n=0
386             \textcolor{keywordflow}{do} i=1, ubound(errors,1)
387               \textcolor{keywordflow}{do} l=1, ubound(errors(i)%val,1)
388                 n=n+1
389                 \textcolor{keywordflow}{if} (.not. inlast) \textcolor{keywordflow}{then}
390                   slope = (model\_data(n)%data(pos+1,l) - model\_data(n)%data\textcolor{comment}{(pos,l))/ &}
391 \textcolor{comment}{                          (model\_data(1)%time(pos+1) - model\_data(1)%time(pos))}
392 \textcolor{comment}{                  modval = model\_data(n)%data(pos+1,l) - slope*dt}
393 \textcolor{comment}{                }\textcolor{keywordflow}{else}
394                   modval = model\_data(n)%data(pos+1,l)
395 \textcolor{keywordflow}{                end if}
396                 
397                 errors(i)%val(l) = errors(i)%val(l) + (modval - exp\_data\textcolor{comment}{(n)%data(j,l))*(modval - exp\_data(n
      )%data(j,l))}
398 \textcolor{comment}{}
399 \textcolor{comment}{}\textcolor{keywordflow}{              end do}
400 \textcolor{keywordflow}{            end do}
401            
402             \textcolor{keywordflow}{EXIT}
403 \textcolor{keywordflow}{          end if}
404 \textcolor{keywordflow}{        end do}
405       
406 \textcolor{keywordflow}{      end do}
407         
408       \textcolor{keywordflow}{do} i=1, ubound(errors,1)  
409         errors(i)%val = sqrt(errors(i)%val)
410 \textcolor{keywordflow}{      end do}
411       
412       \textcolor{keyword}{open}(newunit=outfile, file=\textcolor{stringliteral}{"out/objfnc.val"}, status=\textcolor{stringliteral}{"new"}, action=\textcolor{stringliteral}{"write"}\textcolor{comment}{)}
413 \textcolor{comment}{      }
414 \textcolor{comment}{      }\textcolor{keyword}{write}(outfile, *) \textcolor{stringliteral}{"# values of objective functions"}
415       
416       suma=0
417       \textcolor{keywordflow}{do} i=1, ubound(errors,1)
418         \textcolor{keywordflow}{do} j=1, ubound(errors(i)%val,1)
419          suma = suma + errors(i)%val(j)
420 \textcolor{keywordflow}{        end do}
421 \textcolor{keywordflow}{      end do}
422       \textcolor{keyword}{write}(outfile, *) suma
423       
424       
425       \textcolor{keyword}{close}(outfile)
426                                 
\end{DoxyCode}


Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespaceobjfnc_aa9a5392e2af633f2f53554a6f6f93026_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=211pt]{namespaceobjfnc_aa9a5392e2af633f2f53554a6f6f93026_icgraph}
\end{center}
\end{figure}


\index{objfnc@{objfnc}!reader@{reader}}
\index{reader@{reader}!objfnc@{objfnc}}
\subsubsection[{reader()}]{\setlength{\rightskip}{0pt plus 5cm}subroutine, private objfnc\+::reader (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_ac0a20b2f9874813942bd7dc35e3b4842}


Definition at line 36 of file objfnc.\+f90.



References columns, readtools\+::comment(), datafiles, globals\+::drutes\+\_\+config, exp\+\_\+data, readtools\+::file\+\_\+error(), fileinputs, model\+\_\+data, no\+\_\+pdes, noprop, obs\+\_\+ids, globals\+::observation\+\_\+array, pde\+\_\+objs\+::pde, pde\+\_\+comp, ram\+\_\+limit, typy\+::rkind, and core\+\_\+tools\+::write\+\_\+log().



Referenced by get\+\_\+objval().


\begin{DoxyCode}
36       \textcolor{keywordtype}{use }typy
37       \textcolor{keywordtype}{use }readtools
38       \textcolor{keywordtype}{use }core_tools
39       \textcolor{keywordtype}{use }globals
40       \textcolor{keywordtype}{use }debug_tools
41       \textcolor{keywordtype}{use }pde_objs
42       
43       \textcolor{keywordtype}{integer} :: fileid, expfile, ierr
44       
45       \textcolor{keywordtype}{integer(kind=ikind)} :: n, i, counter, tmpbound, expcols, i1, j, low\textcolor{comment}{, top, skipcount, datacount, l}
46 \textcolor{comment}{      }\textcolor{keywordtype}{character(len=4096)} :: msg
47       \textcolor{keywordtype}{real(kind=rkind)} :: r
48       \textcolor{keywordtype}{real(kind=rkind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: tmpdata
49       \textcolor{keywordtype}{real(kind=rkind)} :: memsize, corr\_memsize
50       \textcolor{keywordtype}{logical}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: skipid
51       \textcolor{keywordtype}{logical} :: go4skip, processed
52       
53       \textcolor{keyword}{open}(newunit=fileid, file=\textcolor{stringliteral}{"drutes.conf/inverse\_modeling/objfnc.conf"}\textcolor{comment}{, action=}\textcolor{stringliteral}{"read"}\textcolor{comment}{, status=}\textcolor{stringliteral}{"old"}\textcolor{comment}{, 
      iostat=ierr)}
54 \textcolor{comment}{      }
55 \textcolor{comment}{      }\textcolor{keywordflow}{if} (ierr /= 0) \textcolor{keywordflow}{then}
56         \textcolor{keyword}{call }write_log(\textcolor{stringliteral}{"unable to open file drutes.conf/inverse\_modeling/objfnc.conf with objective
       function &}
57 \textcolor{stringliteral}{}\textcolor{stringliteral}{        configuration, exiting DRUtES...."})
58         error stop
59 \textcolor{keywordflow}{      end if}
60       
61       \textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"Set the total number of components you want to model"}\textcolor{comment}{, new\_line(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
62 \textcolor{comment}{                    }\textcolor{stringliteral}{"    e.g. your objective function consists of concetration and pressure head values"}\textcolor{comment}{,  
      new\_line(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
63 \textcolor{comment}{                    }\textcolor{stringliteral}{"    then this number is equal 2"}
64                     
65       \textcolor{keyword}{call }fileread(no\_pdes, fileid, errmsg=msg, ranges=(/1\_ikind, 1\_ikind\textcolor{comment}{*ubound(
      pde,1)/))}
66 \textcolor{comment}{      }
67 \textcolor{comment}{      }
68 \textcolor{comment}{      }
69 \textcolor{comment}{      }\textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"The number of PDE component is defined as follows:"}\textcolor{comment}{ , new\_line(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
70 \textcolor{comment}{           }\textcolor{stringliteral}{"      Richards equation - always 1, no other option"},  new\_line\textcolor{comment}{(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
71 \textcolor{comment}{           }\textcolor{stringliteral}{"      Dual permeability problem - 1 for matrix, 2 for fracture"}\textcolor{comment}{,  new\_line(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
72 \textcolor{comment}{           }\textcolor{stringliteral}{"      Advection-dispersion-reaction equation with advection defined in conf files - always 1 ,
       no other option"}\textcolor{comment}{, &}
73 \textcolor{comment}{           new\_line(}\textcolor{stringliteral}{"a"}), &
74            \textcolor{stringliteral}{"      Advection-dispersion-reaction equation with advection computed - 1 for e.g. pressure
       head, &}
75 \textcolor{stringliteral}{}\textcolor{stringliteral}{            2 for concentration"} , & 
76            new\_line(\textcolor{stringliteral}{"a"}), &
77            \textcolor{stringliteral}{"      Advection-dispersion-reaction equation with advection computed and kinetic sorption - & }
78 \textcolor{stringliteral}{}\textcolor{stringliteral}{           1 for e.g. pressure head, 2 for &}
79 \textcolor{stringliteral}{}\textcolor{stringliteral}{           concentration in liquid phase, 3 for concentration in solid phase"}\textcolor{comment}{, new\_line(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), new\_line(}\textcolor{stringliteral}{"a"}\textcolor{comment}{)
      , &}
80 \textcolor{comment}{           }\textcolor{stringliteral}{"I M P O R T A N T !!! the number of lines with pde component ids has to be equal to the number
       of &}
81 \textcolor{stringliteral}{}\textcolor{stringliteral}{           components defined above!!"}
82            
83       
84       \textcolor{keyword}{allocate}(pde\_comp(no\_pdes))
85       
86       \textcolor{keywordflow}{do} i=1, no\_pdes 
87         \textcolor{keyword}{call }fileread(pde\_comp(i), fileid, errmsg=msg, ranges=(/1\_ikind,\textcolor{comment}{ 1\_ikind*ubound(
      pde,1)/))}
88 \textcolor{comment}{}\textcolor{keywordflow}{      end do}
89            
90       
91       
92       \textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"Check the number of your points for constructing objective function, it should be
       equal or lower than "}\textcolor{comment}{, &}
93 \textcolor{comment}{          }\textcolor{stringliteral}{"the number of observation points and at least 1."}, new\_line(\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
94 \textcolor{comment}{          }\textcolor{stringliteral}{"   Your number of observation points is: "},   ubound(
      observation_array\textcolor{comment}{,1)}
95 \textcolor{comment}{      }
96 \textcolor{comment}{      }\textcolor{keyword}{call }fileread(n, fileid, ranges=(/1\_ikind, 1\_ikind*ubound(
      observation_array\textcolor{comment}{,1)/), errmsg=msg)}
97 \textcolor{comment}{      }
98 \textcolor{comment}{      }\textcolor{keyword}{allocate}(obs\_ids(n*no\_pdes))
99       
100       msg=\textcolor{stringliteral}{"Are the numbers of observation points for evaluating your objective function correct?"}
101       
102       \textcolor{keywordflow}{do} i=1, n
103         \textcolor{keyword}{call }fileread(obs\_ids(i), fileid, ranges=(/1\_ikind, 1\_ikind*ubound\textcolor{comment}{(
      observation_array,1)/), errmsg=msg)}
104 \textcolor{comment}{}\textcolor{keywordflow}{      end do}
105 
106       \textcolor{keyword}{allocate}(noprop(n*no\_pdes))
107       
108       \textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"   For each observation point you must specify number of properties you want to check,
       &}
109 \textcolor{stringliteral}{}\textcolor{stringliteral}{          the range is 1 till 4"}, &
110         new\_line(\textcolor{stringliteral}{"a"}), \textcolor{stringliteral}{"1st property is typically solution, 2nd is mass (e.g. water content), 3rd is flux,
       4th cummulative flux."}\textcolor{comment}{, & }
111 \textcolor{comment}{        new\_line(}\textcolor{stringliteral}{"a"}), \textcolor{stringliteral}{"See the head of the output file of the observation points!!"}\textcolor{comment}{ }
112 \textcolor{comment}{      }\textcolor{keywordflow}{do} i=1,n        
113         \textcolor{keyword}{call }fileread(noprop(i), fileid, ranges=(/1\_ikind, 4\_ikind/), errmsg\textcolor{comment}{=msg)}
114 \textcolor{comment}{}\textcolor{keywordflow}{      end do} 
115       
116       
117       \textcolor{keyword}{allocate}(columns(ubound(noprop,1), (maxval(noprop))))
118       
119       \textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"Is the number of columns for evaluating your objective function correct?"}\textcolor{comment}{, new\_line(}\textcolor{stringliteral}{
      "a"}\textcolor{comment}{), &}
120 \textcolor{comment}{          }\textcolor{stringliteral}{" 1st column is reserved for time, start with 2nd column, which is typically reserved for the
       primary solution"}
121       
122       columns = 0
123       
124       \textcolor{keywordflow}{do} i=1, ubound(noprop,1)
125 \textcolor{comment}{!       time, val, massval, advectval(1:D), observation\_array(i)%cumflumemsizex(proc) - in total 4
       properties + time}
126         \textcolor{keyword}{call }fileread(columns(i, 1:noprop(i)), fileid, ranges=(/2\_ikind,\textcolor{comment}{ 5\_ikind/), errmsg=msg, checklen=.
      true.)}
127 \textcolor{comment}{}\textcolor{keywordflow}{      end do}
128       
129       
130       \textcolor{keyword}{call }fileread(fileinputs, fileid)  
131       
132       \textcolor{keyword}{call }write_log(\textcolor{stringliteral}{"The file with inputs for inverse modeling is: "}, text2\textcolor{comment}{=adjustl(trim(fileinputs)))}
133 \textcolor{comment}{      }
134 \textcolor{comment}{      expcols=0}
135 \textcolor{comment}{      }
136 \textcolor{comment}{      }\textcolor{keywordflow}{do} i=1, ubound(noprop,1)
137         expcols=expcols+noprop(i)
138 \textcolor{keywordflow}{      end do}
139       
140             
141       \textcolor{keyword}{open}(newunit=expfile, file=adjustl(trim(fileinputs)), status=\textcolor{stringliteral}{"old"}\textcolor{comment}{, action=}\textcolor{stringliteral}{"read"}\textcolor{comment}{, iostat=ierr)}
142 \textcolor{comment}{      }
143 \textcolor{comment}{      }\textcolor{keywordflow}{if} (ierr /= 0) \textcolor{keywordflow}{then}
144         print *, \textcolor{stringliteral}{"the file with your inputs doesn't exist"}
145         error stop
146 \textcolor{keywordflow}{      end if}
147       
148       \textcolor{keyword}{call }fileread(ram\_limit%set, fileid)
149       
150       \textcolor{keyword}{call }fileread(ram\_limit%memsize, fileid)
151       
152       \textcolor{keyword}{call }fileread(ram\_limit%units, fileid, options=(/\textcolor{stringliteral}{"kB"}, \textcolor{stringliteral}{"MB"}, \textcolor{stringliteral}{"GB"}/\textcolor{comment}{))}
153 \textcolor{comment}{      }
154 \textcolor{comment}{      }\textcolor{keywordflow}{if} (ierr /= 0) \textcolor{keywordflow}{then}
155         \textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"ERROR!, You have specified bad path for input file with experimental data for
       inverse modeling."}\textcolor{comment}{, & }
156 \textcolor{comment}{        new\_line(}\textcolor{stringliteral}{"a"}), &
157         \textcolor{stringliteral}{" The path you have spefied is: "}, adjustl(trim(fileinputs)), new\_line\textcolor{comment}{(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
158 \textcolor{comment}{        }\textcolor{stringliteral}{" The path should start with your DRUtES root directory"}, new\_line\textcolor{comment}{(}\textcolor{stringliteral}{"a"}\textcolor{comment}{), &}
159 \textcolor{comment}{        }\textcolor{stringliteral}{" e.g. drutes.conf/inverse\_modeling/inputs.dat"}
160         \textcolor{keyword}{call }file_error(fileid, msg)
161 \textcolor{keywordflow}{      end if}
162       
163       
164       counter=0
165       \textcolor{keywordflow}{do} 
166         counter=counter+1
167         \textcolor{keyword}{call }comment(expfile)
168         \textcolor{keyword}{read}(unit=expfile, fmt=*, iostat=ierr) r
169         \textcolor{keywordflow}{if} (ierr /= 0) \textcolor{keywordflow}{then}
170           counter = counter-1
171           \textcolor{keywordflow}{EXIT}
172 \textcolor{keywordflow}{        end if}
173 \textcolor{keywordflow}{      end do}
174       
175       \textcolor{keyword}{allocate}(exp\_data(ubound(noprop,1)))
176       
177       \textcolor{keyword}{allocate}(exp\_data(1)%time(counter))
178       
179       \textcolor{keywordflow}{do} i=1, ubound(noprop,1)
180         \textcolor{keyword}{allocate}(exp\_data(i)%data(counter, noprop(i)))
181 \textcolor{keywordflow}{      end do}
182       
183       
184       \textcolor{keyword}{close}(expfile)
185        
186       \textcolor{keyword}{open}(newunit=expfile, file=adjustl(trim(fileinputs)))
187       
188       \textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"ERROR! You have either wrong definition in drutes.conf/inverse\_modeling/objfnc.conf "}\textcolor{comment}{,
       new\_line(}\textcolor{stringliteral}{"a"}\textcolor{comment}{) , &}
189 \textcolor{comment}{        }\textcolor{stringliteral}{"or wrong number of columns in"}, trim(fileinputs), new\_line(\textcolor{stringliteral}{"a"})\textcolor{comment}{, &}
190 \textcolor{comment}{        }\textcolor{stringliteral}{"e.g. for 2 observation points and 2 properties (in total 4 values per time) you need"}\textcolor{comment}{, new\_line(}\textcolor{stringliteral}{
      "a"}\textcolor{comment}{), &}
191 \textcolor{comment}{        }\textcolor{stringliteral}{"5 columns -> 1st col. = time, col. 2-5  = your properties"}
192         
193         
194       \textcolor{keyword}{allocate}(tmpdata(expcols+1))
195       
196       \textcolor{keywordflow}{do} i=1, counter     
197         \textcolor{keyword}{call }fileread(tmpdata, expfile, checklen=.true.)
198         exp\_data(1)%time(i) = tmpdata(1)
199         low=2
200         \textcolor{keywordflow}{do} j=1, ubound(exp\_data,1)
201           top=low+noprop(j)-1
202           exp\_data(j)%data(i, 1:noprop(j)) = tmpdata(low:top)
203           low=top+1
204 \textcolor{keywordflow}{        end do}  
205 \textcolor{keywordflow}{      end do}
206   
207       \textcolor{keyword}{deallocate}(tmpdata)
208       
209       
210       \textcolor{keyword}{allocate}(model\_data(ubound(obs\_ids,1)*no\_pdes))
211       
212       \textcolor{keyword}{allocate}(datafiles(ubound(obs\_ids,1)*no\_pdes))
213       
214       
215       \textcolor{keywordflow}{do} i=1, no\_pdes
216         \textcolor{keywordflow}{do} j=1, ubound(obs\_ids,1)
217           \textcolor{keyword}{open}(newunit=datafiles((i-1)*ubound(obs\_ids,1)+j), file=pde(i)%obspt\_filename\textcolor{comment}{(j), action=}\textcolor{stringliteral}{"read"}\textcolor{comment}{, 
      status=}\textcolor{stringliteral}{"old"}\textcolor{comment}{, & }
218 \textcolor{comment}{               iostat=ierr)}
219 \textcolor{comment}{          }\textcolor{keywordflow}{if} (ierr/=0) \textcolor{keywordflow}{then}
220             print *, \textcolor{stringliteral}{"error opening files with observation points"}
221             print *, \textcolor{stringliteral}{"this is a bug"}
222             print *, \textcolor{stringliteral}{"called from objfnc::reader"}
223             print *, \textcolor{stringliteral}{"contact Michal -> michalkuraz@gmail.com"}
224             error stop
225 \textcolor{keywordflow}{          end if}
226 \textcolor{keywordflow}{        end do}
227 \textcolor{keywordflow}{      end do}
228       
229       counter = 0
230       
231       \textcolor{keywordflow}{do} 
232         counter=counter+1
233         \textcolor{keyword}{call }comment(datafiles(1))
234         \textcolor{keyword}{read}(unit=datafiles(1), fmt=*, iostat=ierr) r
235         \textcolor{keywordflow}{if} (ierr /= 0) \textcolor{keywordflow}{then}
236           counter = counter-1
237           \textcolor{keywordflow}{EXIT}
238 \textcolor{keywordflow}{        end if}     
239 \textcolor{keywordflow}{      end do}
240       
241       memsize = rkind*(ubound(datafiles,1)+1)*counter
242       
243       \textcolor{keywordflow}{select case}(ram\_limit%units)
244         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{"kB"})
245           ram\_limit%memsize = ram\_limit%memsize*1e3
246         
247         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{"MB"})
248           ram\_limit%memsize = ram\_limit%memsize*1e6
249         
250         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{"GB"})
251           ram\_limit%memsize = ram\_limit%memsize*1e9
252         
253 \textcolor{keywordflow}{      end select}
254       
255       \textcolor{keywordflow}{if} (ram\_limit%set .and. memsize > ram\_limit%memsize) \textcolor{keywordflow}{then}
256       
257         corr\_memsize = int(ram\_limit%memsize/(rkind*no\_pdes*ubound(obs\_ids\textcolor{comment}{,1)))*(
      rkind*no\_pdes*ubound(obs\_ids,1))}
258 \textcolor{comment}{        }
259 \textcolor{comment}{        }\textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"of RAM for objective function computation. The datafiles exceeded your RAM limit,
       and thus"}\textcolor{comment}{, &}
260 \textcolor{comment}{                    100-int(corr\_memsize/memsize*100),}\textcolor{stringliteral}{"% of your output data will be skipped."}
261         go4skip=.true.
262         
263       \textcolor{keywordflow}{else}
264         corr\_memsize = memsize
265         \textcolor{keyword}{write}(msg, *) \textcolor{stringliteral}{"of RAM for objective function computation."}
266         go4skip=.false.
267 \textcolor{keywordflow}{      end if}
268       
269       
270       \textcolor{keywordflow}{if} (corr\_memsize < 999) \textcolor{keywordflow}{then}
271         \textcolor{keyword}{call }write_log(\textcolor{stringliteral}{"DRUtES will allocate: "}, int1=1\_ikind*nint(corr\_memsize\textcolor{comment}{), text2=}\textcolor{stringliteral}{"B of RAM"}\textcolor{comment}{, text3=
      trim(msg))}
272 \textcolor{comment}{      }\textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (corr\_memsize > 999 .and. corr\_memsize < 1e6) \textcolor{keywordflow}{then}
273         \textcolor{keyword}{call }write_log(\textcolor{stringliteral}{"DRUtES will allocate: "}, real1=corr\_memsize/1e3,\textcolor{comment}{ text2=}\textcolor{stringliteral}{"kB"}\textcolor{comment}{, text3=trim(msg))}
274 \textcolor{comment}{      }\textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (corr\_memsize > 1e6 .and. corr\_memsize < 1e9 ) \textcolor{keywordflow}{then}
275         \textcolor{keyword}{call }write_log(\textcolor{stringliteral}{"DRUtES will allocate: "}, real1=corr\_memsize/1e6,\textcolor{comment}{ text2=}\textcolor{stringliteral}{"MB"}\textcolor{comment}{, text3=trim(msg))}
276 \textcolor{comment}{      }\textcolor{keywordflow}{else} 
277         \textcolor{keyword}{call }write_log(\textcolor{stringliteral}{"DRUtES will allocate: "}, real1=corr\_memsize/1e9,\textcolor{comment}{ text2=}\textcolor{stringliteral}{"GB"}\textcolor{comment}{, text3=trim(msg))}
278 \textcolor{comment}{}\textcolor{keywordflow}{      end if}
279       
280       \textcolor{keyword}{close}(datafiles(1))
281       
282       \textcolor{keyword}{open}(newunit=datafiles(1), file=pde(1)%obspt\_filename(1), action=\textcolor{stringliteral}{"read"}\textcolor{comment}{, status=}\textcolor{stringliteral}{"old"}\textcolor{comment}{)}
283 \textcolor{comment}{      }
284 \textcolor{comment}{      }\textcolor{keywordflow}{if} (go4skip) \textcolor{keywordflow}{then}
285         
286         \textcolor{keyword}{allocate}(skipid(counter))
287         
288         skipid = .false.
289         
290         skipcount =  (int((memsize-corr\_memsize)/memsize*counter)+1)
291         
292         i=0
293         \textcolor{keywordflow}{do} 
294           \textcolor{keyword}{call }random\_seed()
295           n = int(counter*rand(0))
296           \textcolor{keywordflow}{if} (n>0) \textcolor{keywordflow}{then}
297             \textcolor{keywordflow}{if} (.not. skipid(n)) \textcolor{keywordflow}{then}
298               i = i + 1
299               skipid(n) = .true.
300 \textcolor{keywordflow}{            end if}
301 \textcolor{keywordflow}{          end if}
302             
303           \textcolor{keywordflow}{if} (i == skipcount) \textcolor{keywordflow}{EXIT}
304 \textcolor{keywordflow}{        end do}
305 
306         datacount = counter-skipcount
307       \textcolor{keywordflow}{else}
308         datacount = counter
309 \textcolor{keywordflow}{      end if}
310       
311       \textcolor{keyword}{allocate}(model\_data(1)%time(datacount))
312       
313       \textcolor{keywordflow}{do} i=1, ubound(model\_data,1)
314         \textcolor{keyword}{allocate}(model\_data(i)%data(datacount, noprop(i)))
315 \textcolor{keywordflow}{      end do}
316       
317       \textcolor{keyword}{allocate}(tmpdata(4+drutes_config%dimen))
318 
319       \textcolor{keywordflow}{do} i=1, ubound(model\_data,1)
320         n=0
321         \textcolor{keywordflow}{do} l=1, counter
322           processed=.false.
323           \textcolor{keyword}{call }fileread(tmpdata, datafiles(i))
324 
325           \textcolor{keywordflow}{if} (\textcolor{keyword}{allocated}(skipid)) \textcolor{keywordflow}{then}
326             \textcolor{keywordflow}{if} (.not. skipid(l)) \textcolor{keywordflow}{then}
327               processed = .true.
328               n=n+1
329 \textcolor{keywordflow}{            end if}
330           \textcolor{keywordflow}{else}
331             processed = .true.
332             n=n+1
333 \textcolor{keywordflow}{          end if}
334           
335           \textcolor{keywordflow}{if} (i==1 .and. processed) \textcolor{keywordflow}{then}
336             model\_data(i)%time(n) = tmpdata(1)
337 \textcolor{keywordflow}{          end if}
338         
339           \textcolor{keywordflow}{if} (processed) \textcolor{keywordflow}{then}
340             \textcolor{keywordflow}{do} j=1, noprop(i)
341               model\_data(i)%data(n,j) = tmpdata(columns(i,j))
342 \textcolor{keywordflow}{            end do}
343 \textcolor{keywordflow}{          end if}
344 \textcolor{keywordflow}{        end do}
345 \textcolor{keywordflow}{      end do}  
346     
\end{DoxyCode}


Here is the call graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=263pt]{namespaceobjfnc_ac0a20b2f9874813942bd7dc35e3b4842_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=323pt]{namespaceobjfnc_ac0a20b2f9874813942bd7dc35e3b4842_icgraph}
\end{center}
\end{figure}




\subsection{Variable Documentation}
\index{objfnc@{objfnc}!columns@{columns}}
\index{columns@{columns}!objfnc@{objfnc}}
\subsubsection[{columns}]{\setlength{\rightskip}{0pt plus 5cm}integer(kind=ikind), dimension(\+:,\+:), allocatable, private objfnc\+::columns\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_adb2a7345e2fae82f69a013ae851a0681}


Definition at line 24 of file objfnc.\+f90.



Referenced by reader().


\begin{DoxyCode}
24   \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{dimension(:,:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{private} :: columns
\end{DoxyCode}
\index{objfnc@{objfnc}!datafiles@{datafiles}}
\index{datafiles@{datafiles}!objfnc@{objfnc}}
\subsubsection[{datafiles}]{\setlength{\rightskip}{0pt plus 5cm}integer, dimension(\+:), allocatable objfnc\+::datafiles}\label{namespaceobjfnc_aa04790f1deb9667d535af168d202ae35}


Definition at line 28 of file objfnc.\+f90.



Referenced by reader().


\begin{DoxyCode}
28   \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: datafiles
\end{DoxyCode}
\index{objfnc@{objfnc}!exp\+\_\+data@{exp\+\_\+data}}
\index{exp\+\_\+data@{exp\+\_\+data}!objfnc@{objfnc}}
\subsubsection[{exp\+\_\+data}]{\setlength{\rightskip}{0pt plus 5cm}type({\bf point\+\_\+str}), dimension(\+:), allocatable, private objfnc\+::exp\+\_\+data\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_aa0f23751e770ce7a6dc79a3bbb6bd2cb}


Definition at line 20 of file objfnc.\+f90.



Referenced by get\+\_\+objval(), and reader().


\begin{DoxyCode}
20   \textcolor{keywordtype}{type}(point\_str), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{private} :: exp\_data
\end{DoxyCode}
\index{objfnc@{objfnc}!exp\+\_\+file@{exp\+\_\+file}}
\index{exp\+\_\+file@{exp\+\_\+file}!objfnc@{objfnc}}
\subsubsection[{exp\+\_\+file}]{\setlength{\rightskip}{0pt plus 5cm}integer, private objfnc\+::exp\+\_\+file\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_a7b8adf7e1a2f8fd5143d33f41f208c00}


Definition at line 7 of file objfnc.\+f90.


\begin{DoxyCode}
7   \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{private} :: exp\_file
\end{DoxyCode}
\index{objfnc@{objfnc}!fileinputs@{fileinputs}}
\index{fileinputs@{fileinputs}!objfnc@{objfnc}}
\subsubsection[{fileinputs}]{\setlength{\rightskip}{0pt plus 5cm}character(len=4096), private objfnc\+::fileinputs\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_a31eae2b00085eccaad9921c4b95e2c84}


Definition at line 25 of file objfnc.\+f90.



Referenced by reader().


\begin{DoxyCode}
25   \textcolor{keywordtype}{character(len=4096)}, \textcolor{keywordtype}{private} :: fileinputs
\end{DoxyCode}
\index{objfnc@{objfnc}!model\+\_\+data@{model\+\_\+data}}
\index{model\+\_\+data@{model\+\_\+data}!objfnc@{objfnc}}
\subsubsection[{model\+\_\+data}]{\setlength{\rightskip}{0pt plus 5cm}type({\bf point\+\_\+str}), dimension(\+:), allocatable, private objfnc\+::model\+\_\+data\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_a57dd49eaed017851cdf03a28bcd5cd58}


Definition at line 21 of file objfnc.\+f90.



Referenced by get\+\_\+objval(), and reader().


\begin{DoxyCode}
21   \textcolor{keywordtype}{type}(point\_str), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{private} :: model\_data
\end{DoxyCode}
\index{objfnc@{objfnc}!no\+\_\+pdes@{no\+\_\+pdes}}
\index{no\+\_\+pdes@{no\+\_\+pdes}!objfnc@{objfnc}}
\subsubsection[{no\+\_\+pdes}]{\setlength{\rightskip}{0pt plus 5cm}integer(kind=ikind), private objfnc\+::no\+\_\+pdes\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_ab31bdc49001762f0764208f8be4d058b}


Definition at line 27 of file objfnc.\+f90.



Referenced by reader().


\begin{DoxyCode}
27   \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{private} ::  no\_pdes
\end{DoxyCode}
\index{objfnc@{objfnc}!noprop@{noprop}}
\index{noprop@{noprop}!objfnc@{objfnc}}
\subsubsection[{noprop}]{\setlength{\rightskip}{0pt plus 5cm}integer(kind=ikind), dimension(\+:), allocatable, private objfnc\+::noprop\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_a77131f874ccc4d3cefcae2947d1cb4e7}


Definition at line 23 of file objfnc.\+f90.



Referenced by get\+\_\+objval(), and reader().


\begin{DoxyCode}
23   \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{private} :: noprop, pde\_comp
\end{DoxyCode}
\index{objfnc@{objfnc}!obs\+\_\+ids@{obs\+\_\+ids}}
\index{obs\+\_\+ids@{obs\+\_\+ids}!objfnc@{objfnc}}
\subsubsection[{obs\+\_\+ids}]{\setlength{\rightskip}{0pt plus 5cm}integer(kind=ikind), dimension(\+:), allocatable, private objfnc\+::obs\+\_\+ids\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_abecd874fad6a0eee4d9145b4850ef3c8}


Definition at line 22 of file objfnc.\+f90.



Referenced by reader().


\begin{DoxyCode}
22   \textcolor{keywordtype}{integer(kind=ikind)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable}, \textcolor{keywordtype}{private} :: obs\_ids
\end{DoxyCode}
\index{objfnc@{objfnc}!pde\+\_\+comp@{pde\+\_\+comp}}
\index{pde\+\_\+comp@{pde\+\_\+comp}!objfnc@{objfnc}}
\subsubsection[{pde\+\_\+comp}]{\setlength{\rightskip}{0pt plus 5cm}integer(kind=ikind), dimension(\+:), allocatable, private objfnc\+::pde\+\_\+comp\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_ac1c6d931e040f0b4a43a2cdfd280b10d}


Definition at line 23 of file objfnc.\+f90.



Referenced by reader().

\index{objfnc@{objfnc}!ram\+\_\+limit@{ram\+\_\+limit}}
\index{ram\+\_\+limit@{ram\+\_\+limit}!objfnc@{objfnc}}
\subsubsection[{ram\+\_\+limit}]{\setlength{\rightskip}{0pt plus 5cm}type({\bf ram\+\_\+limit\+\_\+str}), private objfnc\+::ram\+\_\+limit\hspace{0.3cm}{\ttfamily [private]}}\label{namespaceobjfnc_a7d3ea4fe32ff44c9a2e6884f7ae27259}


Definition at line 26 of file objfnc.\+f90.



Referenced by reader().


\begin{DoxyCode}
26   \textcolor{keywordtype}{type}(ram\_limit\_str), \textcolor{keywordtype}{private} :: ram\_limit
\end{DoxyCode}
